<div class="all">
    <app-header [view]="'admin'" [isDataRetrieved]="this.isDataRetrieved" [msgs]="this.msgs" [collections]="this.collections" ></app-header>
    <p-splitter [style]="{display: 'flex'}" [panelSizes]="this.panelSizes">
        <ng-template pTemplate>
            <div class="flex flex-column flex-grow-1">
                <!-- DROP ZONE -->
                <div class="collections">
                    <div class="dropZone flexColumn">
                        <span class="dropTitle">NEW COLLECTION</span>
                        <input class="newColField" id="collection" type="text" [(ngModel)]="this.collection" placeholder="name">
                        <button pTooltip="{{this.collection == ''? 'Must enter name' : 'Add new collection'}}" tooltipPosition="bottom" class="{{this.collection == ''? 'disAddButton': 'addButton'}}">
                                <i class="addIcon pi pi-plus" (click)="insertCollection(this.collection,this.cover)"></i>
                        </button>
                    </div>
                    <ng-template ngFor let-collection [ngForOf]="this.collections">
                        <div class="dropZone flexColumn" pDroppable="loaded" (onDrop)="drop(collection.label)" (mouseenter)="this.showDropped[collection.label] = true" (mouseleave)="this.showDropped[collection.label] = false">
                            <img class="covers" src="data:image/png;base64,{{ collection.b64 }}">
                            <span class="dropTitle">
                               {{collection.label}} <div class="removeDiv" (click)="this.removeCollection(collection.value)"><i class="removeIcon fa fa-trash"></i></div> 
                            </span>
                            <ng-template ngFor let-im [ngForOf]="this.dropped[collection.label]">
                                <div *ngIf="this.showDropped[collection.label]" class="droppedTitle flex flex-column" (click)="this.editImage(im)">
                                    <span><h5 class="imTitle">{{im.title}}</h5></span>
                                </div>
                            </ng-template>
                        </div>
                    </ng-template>
                </div>

                <!-- UPLOAD FORM -->
                <div class="flex align-items-center">
                    <form class="flex w-full" [formGroup]="uploadForm" (submit)="uploadToBackend()">
                    <div class="uploadForm">
                        <div>
                            <label for="fileNames">
                                <i class="folderIcon pi pi-folder-open">
                                    <span> Browse your files</span>
                                </i>
                            </label>
                            <input multiple id="fileNames" type="file" class="file-upload" (change)="loadedFiles($event)"
                                formControlName="fileNames">
                        </div>
                        <div class="flex justify-content-center align-items-center">
                            <button pTooltip="{{this.isDroppedEmpty()? 'Must drop at least one image into some collection' : 'давай'}}" 
                            tooltipPosition="left" 
                            class="{{this.isDroppedEmpty()? 'disUploadButton': 'uploadButton'}}" 
                            [disabled]="this.isDroppedEmpty() ? true : null" type="submit">
                                <label>
                                    <i class="uploadIcon pi pi-cloud-upload">
                                        <span> Upload</span>
                                    </i>
                                </label>
                            </button>
                        </div>
                    </div>
                    </form>
                </div>
                <div>
                    <p-progressBar [value]="this.syncProgress"></p-progressBar>
                </div>

                <!-- LOADED FILES -->
                <div>
                    <button [attr.disabled]="!this.uploadView ? null : true" (click)="this.switch()">SHOW FILES TO UPLOAD</button>
                    <button [attr.disabled]="this.uploadView ? null : true" (click)="this.switch()">SHOW REMOVED IMAGES</button>
                </div>
                <div class="flex align-items-center justify-content-center">
                    <span>{{this.uploadView ? 'Files to upload:' : 'Removed images:'}}</span>
                </div>
                <div class="gallery" >
                    <div *ngIf="this.uploadView && this.loadedImages.length == 0"> Upload images from your device </div>
                    <div *ngIf="!this.uploadView && this.noCollection.length == 0"> No removed images </div>
                    <ng-template ngFor let-im [ngForOf]="this.uploadView ? this.loadedImages : this.noCollection" let-i="index">
                        <div class="flex flex-column" pDraggable="loaded" (onDragStart)="dragStart(im)" (onDragEnd)="dragEnd()">
                            <div class="flex flex-column" (click)="this.editImage(im)" >
                                <img class="imGallery" src="{{ im.b64 }}">
                                <span><h4 class="imTitle">{{im.title}}</h4></span>
                            </div>
                        </div>
                    </ng-template>
                </div>
            </div>
        </ng-template>
        <!-- EDIT ZONE -->
        <ng-template  pTemplate>
            <div  *ngIf="this.showIm" class="editZone">
                <div class="editImage" pDraggable="loaded" (onDragStart)="dragStart(this.image)" (onDragEnd)="dragEnd()">
                    <img class="imEdit" src="{{ this.image.b64 }}">
                </div>
                <div class="editForm flexColumn">
                    <form [formGroup]="editForm" class="editForm flexColumn">
                        <div class="editField flexColumn p-float-label">
                            <input class="title" type="text" id="title" pInputText formControlName="title" maxlength="200" (input)="onEdit($event)">
                            <label for="title"><span>Description ({{this.editForm.value.title?.length}}/{{'200'}})</span></label>
                        </div>
                        <div class="editField flexColumn">
                            <!-- need to check if this.image.keywords length is > 29 -->
                            <label for="keywords"><span>keywords ({{this.image.keywords.length}}/{{'30'}})</span></label>
                            <p-chips class="keywords" formControlName="keywords" (input)="keyInput()">
                            </p-chips>
                        </div>
                    </form>
                </div>
            </div>
        </ng-template>
    </p-splitter>
</div>

<div *ngIf="this.showResult">
    <p-dialog header="UPLOAD RESULT" [(visible)]="this.showResult" [modal]="true" [style]="{width: 'auto'}"
        [maximizable]="true" [draggable]="false" [resizable]="true" class="resultPopup">
        <div class="uploadResult">
        <ng-template ngFor let-colUpload [ngForOf]="this.uploadResult">
            <div class="collectionResult">
                <span class="colTitle">/{{colUpload.collection}}</span>
                <div class="arrayResult insertResult flexColumn" *ngIf="colUpload.inserted?.length > 0">
                    <span>inserted:</span>
                    <ng-template ngFor let-inserted [ngForOf]="colUpload.inserted">
                        <div class="arrayElement flex flex-column">
                            <span>id:{{inserted.id}}</span>
                            <span>name:{{inserted.file_name}}</span>
                            <span>title:{{inserted.title}}</span>
                        </div>
                    </ng-template>
                </div>
                <div class="arrayResult updatedResult flexColumn" *ngIf="colUpload.updated?.length > 0">
                    <span>updated:</span>
                    <ng-template ngFor let-updated [ngForOf]="colUpload.updated">
                        <div class="arrayElement flex flex-column">
                            <span>id:{{updated.id}}</span>
                            <span>name:{{updated.file_name}}</span>
                            <span>title:{{updated.title}}</span>
                        </div>
                    </ng-template>
                </div>
                <div class="arrayResult resizeResult flexColumn" *ngIf="colUpload.resized?.length > 0">
                    <span>resized:</span>
                    <ng-template ngFor let-resized [ngForOf]="colUpload.resized">
                        <div class="arrayElement resizeElement flex flex-column">
                            {{resized}}
                        </div>
                    </ng-template>
                </div>
            </div>
            
        </ng-template>
        <a class="btn btn-clear" title="uploadResult" [href]="jsonUrl" 
        download="pstock_upload{{this.uploadResult[0].date | date:'dd_MM_yyyy_HH_mm_ss'}}.json">DOWNLOAD JSON</a>
        </div>
    </p-dialog>
</div>